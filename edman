#!/bin/bash

#    Embedded System Manager
#    Copyright (C) 2026  Briar Merrett
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <https://www.gnu.org/licenses/>.

# Function to check for root privileges
check_root() {
  if [ "$(id -u)" -ne 0 ]; then
    echo "ERROR: This command requires root privileges. Please run with sudo."
    exit 1
  fi
}

# Function to load config file with error handling
load_config() {
  if [ "$(id -u)" -eq 0 ]; then
    if [ ! -f "/opt/embedded-system-manager/config" ]; then
      echo "ERROR: Configuration file not found at /opt/embedded-system-manager/config"
      echo "Please run setup again or check your installation."
      exit 1
    fi

    if ! source "/opt/embedded-system-manager/config"; then
      echo "ERROR: Failed to load configuration file."
      echo "The config file may be corrupted. Please run 'edman configsetup' to regenerate it."
      exit 1
    fi
  fi
}

case $1 in
  "reset")
    check_root
    echo "Resetting embedded-system-deployer service..."
    systemctl restart embedded-system-deployer.service
    ;;

  "status")
    check_root
    systemctl status embedded-system-deployer.service
    ;;

  "output")
    check_root
    journalctl --follow -u embedded-system-deployer.service
    ;;

  "stop")
    check_root
    echo "Stopped embedded-system-deployer service."
    systemctl stop embedded-system-deployer.service
    ;;

  "info")
    check_root
    echo "reading from /opt/embedded-system-manager/info.txt"
    echo "-----------------------------------"
    cat /opt/embedded-system-manager/info.txt
    echo ""
    ;;

  "config")
    check_root
    load_config
    ${EDITOR:-nano} /opt/embedded-system-manager/config
    ;;

  "configsetup")
    check_root
    exec /opt/embedded-system-manager/config_setup.sh
    ;;


  "gotoscripts")
    if [ ! -f "/opt/embedded-system-manager/paths.conf" ]; then
      echo "ERROR: Paths configuration file not found at /opt/embedded-system-manager/paths.conf"
      if [ "${BASH_SOURCE[0]}" != "${0}" ]; then
        return 1
      else
        exit 1
      fi
    fi

    if ! source "/opt/embedded-system-manager/paths.conf"; then
      echo "ERROR: Failed to load paths configuration file."
      if [ "${BASH_SOURCE[0]}" != "${0}" ]; then
        return 1
      else
        exit 1
      fi
    fi
    # Validate script_workspace is set and not empty
    if [ -z "${script_workspace:-}" ]; then
      echo "ERROR: script_workspace is not configured."
      if [ "${BASH_SOURCE[0]}" != "${0}" ]; then
        return 1
      else
        exit 1
      fi
    fi
    
    if [ -d "$script_workspace" ]; then
      # Check if script is being sourced
      if [ "${BASH_SOURCE[0]}" != "${0}" ]; then
        # Script is being sourced, we can change directory
        if ! cd "$script_workspace"; then
          echo "ERROR: Failed to change directory to: $script_workspace"
          return 1
        fi
        echo "Changed directory to: $script_workspace"
      else
        # Script is being executed, can't change parent shell's directory
        echo "To change to scripts directory, run:"
        echo "  source edman gotoscripts"
        echo "or"
        echo "  . edman gotoscripts"
        exit 0
      fi
    else
      echo "ERROR: Scripts directory does not exist: $script_workspace"
      if [ "${BASH_SOURCE[0]}" != "${0}" ]; then
        return 1
      else
        exit 1
      fi
    fi
    ;;

  "uninstall")
    check_root
    load_config
    exec /opt/embedded-system-manager/uninstall.sh
    ;;

  *)
    printf -- "-- Embedded System Manager --\n
    Arguments:\n
    reset - Restarts the service.\n
    status - Check systemctl status of the embedded-system-deployer service.\n
    output - Start displaying live output of the embedded-system-deployer service.\n
    stop - Stops the embedded-system-deployer service.\n
    info - Show info.txt in embedded-system-deployer.\n
    config - Open embedded-system-manager config in default editor (${EDITOR:-nano}).\n
    configsetup - Re-run the config setup TUI that was ran on first setup.\n
    gotoscripts - Change current directory to the directory where the downloaded repository is stored.\n
    uninstall - Completely remove Embedded System Manager from the system.\n
    help - Show this list of command arguments.\n\n" ;;
esac
